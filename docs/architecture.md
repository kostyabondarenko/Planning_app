# Архитектура проекта

Здесь описывается, как устроено наше приложение "Навигатор Целей" (Goal Navigator).

## Основные принципы
1. **Читаемость кода** - Код должен быть понятен другим разработчикам
2. **Актуальная документация** - Документация обновляется при значимых изменениях
3. **Следование правилам** - Все изменения делаются согласно `agents.md`
4. **Безопасность** - JWT-аутентификация, изоляция данных пользователей

## Архитектура системы

### Backend (FastAPI + SQLAlchemy)
```
backend/
├── app/
│   ├── main.py           # Точка входа, регистрация роутеров
│   ├── database.py       # Настройка БД (PostgreSQL)
│   ├── models.py         # ORM модели (User, Goal, Step, Todo)
│   ├── schemas.py        # Pydantic схемы для валидации
│   ├── auth.py          # JWT аутентификация
│   └── routers/         # API эндпоинты
│       ├── auth.py      # Регистрация и вход
│       ├── goals.py     # CRUD для целей и шагов
│       └── todos.py     # CRUD для задач
└── tests/               # Unit-тесты
```

### Frontend (Next.js + Tailwind CSS)
```
frontend/src/app/
├── page.tsx             # Лендинг
├── login/              # Страница входа
├── register/           # Страница регистрации
└── dashboard/          # Защищенная зона
    ├── page.tsx        # Список целей
    ├── daily/          # Задачи на день
    └── calendar/       # Календарное представление
```

### База данных (PostgreSQL)
```
users          goals              steps              todos
------         ------             ------             ------
id             id                 id                 id
email          user_id (FK)       goal_id (FK)       user_id (FK)
hashed_pwd     title              title              step_id (FK, opt)
               description        is_completed       title
               deadline           order              date
               status                                is_completed
```

## Полный User Flow

### 1. Первое знакомство с приложением
**Шаг 1.1:** Пользователь переходит на главную страницу (`/`)
- Видит лендинг с описанием приложения
- Кнопки "Войти" и "Зарегистрироваться"

**Шаг 1.2:** Регистрация нового пользователя (`/register`)
- Вводит email и пароль
- POST запрос на `/auth/register`
- Backend создает запись в таблице `users` с хешированным паролем
- Автоматический переход на страницу входа

**Шаг 1.3:** Вход в систему (`/login`)
- Вводит email и пароль
- POST запрос на `/auth/login`
- Backend проверяет credentials, возвращает JWT-токен
- Frontend сохраняет токен (localStorage/cookies)
- Редирект на Dashboard

### 2. Работа с целями

**Шаг 2.1:** Просмотр дашборда (`/dashboard`)
- GET запрос на `/goals/` с Authorization header
- Backend возвращает все цели пользователя с расчетом прогресса
- Отображаются карточки целей с:
  - Названием и описанием
  - Прогресс-баром (% выполненных шагов)
  - Статусом (в процессе/завершена)
  - Дедлайном (если установлен)

**Шаг 2.2:** Создание новой цели
- Пользователь нажимает "Создать цель"
- Заполняет форму (title, description, deadline опционально)
- POST запрос на `/goals/`
- Backend создает запись в таблице `goals`
- Frontend обновляет список целей

**Шаг 2.3:** Просмотр деталей цели
- Клик на карточку цели
- GET запрос на `/goals/{goal_id}`
- Отображается детальная информация:
  - Полное описание цели
  - Список всех шагов (дерево шагов)
  - Кнопка "Добавить шаг"

**Шаг 2.4:** Добавление шагов к цели
- Нажатие "Добавить шаг" внутри цели
- Ввод названия шага
- POST запрос на `/goals/{goal_id}/steps`
- Backend создает запись в таблице `steps`
- Шаг добавляется в список

**Шаг 2.5:** Отметка шага как выполненного
- Клик на чекбокс рядом с шагом
- PUT запрос на обновление шага
- Backend обновляет `is_completed = True`
- Пересчитывается прогресс цели автоматически
- Прогресс-бар обновляется на UI

**Шаг 2.6:** Просмотр статистики
- GET запрос на `/goals/stats`
- Backend анализирует все цели пользователя:
  - Общее количество целей
  - Количество завершенных целей
  - Средний прогресс по всем целям
  - Общее количество шагов
  - Количество выполненных шагов
- Отображение графиков и диаграмм на UI

### 3. Работа с задачами (ToDo)

**Шаг 3.1:** Переход в раздел "Задачи на день" (`/dashboard/daily`)
- GET запрос на `/todos/`
- Backend возвращает все задачи пользователя
- Frontend фильтрует по дате (сегодня/завтра/неделя)

**Шаг 3.2:** Создание быстрой задачи
- Ввод текста задачи и выбор даты
- POST запрос на `/todos/`
- Задача может быть:
  - Независимой (step_id = null)
  - Привязанной к шагу цели (step_id указан)

**Шаг 3.3:** Отметка задачи как выполненной
- Клик на чекбокс
- PUT запрос на `/todos/{todo_id}`
- Backend обновляет `is_completed = True`
- Задача визуально помечается как выполненная

**Шаг 3.4:** Удаление задачи
- Свайп или кнопка "Удалить"
- DELETE запрос на `/todos/{todo_id}`
- Задача удаляется из списка

### 4. Работа с календарем

**Шаг 4.1:** Переход в календарь (`/dashboard/calendar`)
- Отображается сетка месяца/недели
- На датах отмечаются:
  - Задачи (todos) с их датами
  - Дедлайны целей
  - Количество задач на каждый день

**Шаг 4.2:** Клик на дату
- Показывается список всех задач на этот день
- Возможность добавить новую задачу на выбранную дату

### 5. Безопасность и изоляция данных

**Принцип изоляции:**
- Каждый API-запрос проверяет JWT-токен через `get_current_user()`
- Все запросы фильтруются по `user_id` текущего пользователя
- Невозможно получить доступ к чужим целям/задачам
- Попытка доступа к чужим данным возвращает 404 (Not Found), а не 403 (Forbidden) для безопасности

**Пример защиты:**
```python
# В каждом эндпоинте:
current_user: models.User = Depends(auth.get_current_user)
goals = db.query(models.Goal).filter(models.Goal.user_id == current_user.id).all()
```

### 6. Расчет прогресса (Ключевая логика)

**Алгоритм расчета прогресса цели:**
```
progress = (completed_steps / total_steps) * 100

Если total_steps == 0, то progress = 0%
```

**Алгоритм расчета средней статистики:**
```
average_progress = sum(progress каждой цели) / total_goals

Если total_goals == 0, то average_progress = 0%
```

**Важно:** Прогресс вычисляется динамически при каждом GET-запросе, не хранится в БД.

## API Endpoints Summary

### Auth
- `POST /auth/register` - Регистрация
- `POST /auth/login` - Вход (возвращает JWT)

### Goals
- `POST /goals/` - Создать цель
- `GET /goals/` - Получить все цели (с прогрессом)
- `GET /goals/{goal_id}` - Получить одну цель
- `DELETE /goals/{goal_id}` - Удалить цель
- `GET /goals/stats` - Статистика пользователя
- `POST /goals/{goal_id}/steps` - Добавить шаг к цели

### Todos
- `POST /todos/` - Создать задачу
- `GET /todos/` - Получить все задачи
- `GET /todos/{todo_id}` - Получить задачу
- `PUT /todos/{todo_id}` - Обновить задачу
- `DELETE /todos/{todo_id}` - Удалить задачу

## Тестирование

### Структура тестов
```
backend/tests/
├── conftest.py        # Фикстуры (session, client, auth_client)
├── test_goals.py      # Тесты для целей и шагов
├── test_todos.py      # Тесты для задач
└── test_progress.py   # Тесты логики расчета прогресса
```

### Покрытие тестами
- ✅ Создание/чтение/удаление целей
- ✅ Добавление шагов к целям
- ✅ Расчет прогресса (все edge cases)
- ✅ Статистика пользователя
- ✅ CRUD операции с задачами
- ✅ Изоляция данных между пользователями
- ✅ Связывание задач с шагами целей

### Запуск тестов
```bash
cd backend
pytest -v              # Все тесты с подробным выводом
pytest tests/test_progress.py  # Только тесты прогресса
```
