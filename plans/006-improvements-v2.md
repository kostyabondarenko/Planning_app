# План: Доработки v2 — Прогресс, фильтрация, навигация, календарь

## Общее описание

Второй поток доработок по обратной связи. Исправление бага с обновлением прогресса, добавление фильтрации на странице "Ближайшие дни", улучшения календаря (сворачиваемая сетка, мультивыбор целей, визуализация вех), исправление навигации по логотипу.

---

## Входящие требования

### Баги
- При отметке действия выполненным на странице "Цели" (внутри вехи) прогресс не обновляется до перезагрузки

### UI/UX улучшения
- Фильтрация по целям на странице "Ближайшие дни"
- Логотип "Goal Navigator" должен вести на страницу "Цели" (`/dashboard`), а не на стартовую (`/`)
- Сворачиваемая сетка календаря при выборе дня
- Мультивыбор целей в фильтре календаря
- Визуализация вех на таймлайне календаря

---

## План реализации

### Этап 1: Исправление обновления прогресса на странице "Цели"
**Статус:** ✅ Выполнен

**Проблема:**
Когда пользователь отмечает действие выполненным на странице цели (внутри вехи), прогресс цели/вехи не обновляется в UI. Корень проблемы: `useMilestone` обновляет локальное состояние вехи после toggle, но хук `useGoal` на родительской странице цели не знает об изменении и не рефетчит данные.

**Промпт для Claude Code:**
```
Выполни Этап 1 из plans/006-improvements-v2.md.

Исправь баг: при отметке действия выполненным на странице цели прогресс не обновляется без перезагрузки.

Корень проблемы: useMilestone.ts обновляет локальное состояние после toggleOneTimeAction/toggleRecurringAction, но useGoal.ts на странице цели не узнаёт об изменении.

Решение — после toggle действия рефетчить данные цели:

1. В useMilestone.ts:
   - Добавь опциональный callback onProgressChange в параметры хука
   - После успешного toggle (toggleOneTimeAction, toggleRecurringAction) — вызывай onProgressChange()

2. В milestone/[milestoneId]/page.tsx:
   - Не нужно менять, callback будет вызываться из хука

3. В goal/[id]/page.tsx:
   - При передаче useMilestone — передавай callback, который вызывает refetch() из useGoal
   - Альтернатива: если milestone используется через дочерний компонент, прокинь refetch через props или context

4. Убедись, что:
   - После toggle действия прогресс цели обновляется мгновенно (без перезагрузки)
   - Прогресс вехи тоже обновляется (уже работает)
   - Анимация ProgressCircle корректно проигрывается при изменении значения

Важно: изучи текущую архитектуру — как goal/[id]/page.tsx рендерит вехи и их действия. Возможно, milestone рендерится inline на странице цели (не через отдельную страницу), тогда решение может быть другим: достаточно вызвать refetch() хука useGoal после toggle.
```

**Результат:**
- [x] После toggle действия прогресс цели обновляется мгновенно
- [x] Прогресс вехи обновляется мгновенно
- [x] Нет лишних сетевых запросов

---

### Этап 2: Исправление навигации по логотипу
**Статус:** ✅ Выполнен

**Промпт для Claude Code:**
```
Выполни Этап 2 из plans/006-improvements-v2.md.

В файле frontend/src/app/dashboard/layout.tsx измени href логотипа "Goal Navigator" с "/" на "/dashboard", чтобы клик по логотипу вёл на страницу "Цели", а не на стартовую страницу.

Найди строку:
<Link href="/" className="flex items-center gap-2 group">

Замени на:
<Link href="/dashboard" className="flex items-center gap-2 group">
```

**Результат:**
- [x] Клик по "Goal Navigator" ведёт на `/dashboard` (страница "Цели")

---

### Этап 3: Фильтрация по целям на странице "Ближайшие дни"
**Статус:** ✅ Выполнен

**Промпт для Claude Code:**
```
Выполни Этап 3 из plans/006-improvements-v2.md.

Используй скиллы: brandbook-stylist, fastapi-crud

Добавь фильтрацию по целям на странице "Ближайшие дни" (Kanban-доска):

1. Backend (если нужно):
   - Проверь, поддерживает ли эндпоинт GET /api/tasks/range параметр goal_id
   - Если нет — добавь опциональный query param goal_id для фильтрации задач по цели
   - Также нужен эндпоинт для получения списка целей (скорее всего уже есть GET /api/v2/goals)

2. Frontend — компонент фильтра:
   - Добавь панель фильтрации над Kanban-доской (аналогично GoalFilter в календаре)
   - Pill-кнопки: "Все цели" + кнопка для каждой активной цели
   - Каждая цель с цветной точкой (используй GOAL_COLORS как в календаре)
   - Мультивыбор: можно выбрать несколько целей одновременно (checkbox-стиль)
   - Все цели выбраны по умолчанию

3. Интеграция с KanbanBoard:
   - Передавай выбранные goal_id в KanbanBoard как prop
   - KanbanBoard фильтрует задачи по выбранным целям
   - При изменении фильтра — обновлять отображение без перезагрузки

4. Стилизация:
   - Стиль pill-кнопок как в календаре (GoalFilter)
   - Адаптивность: горизонтальный скролл на мобильных
   - Поддержка light/dark темы

Компонент фильтра должен переиспользовать стили/подход из GoalFilter (calendar), но поддерживать мультивыбор.
```

**Результат:**
- [x] Панель фильтрации по целям над Kanban-доской
- [x] Мультивыбор целей
- [x] Фильтрация задач работает корректно
- [x] Стили по brandbook

---

### Этап 4: Мультивыбор целей в фильтре календаря
**Статус:** ✅ Выполнен

**Промпт для Claude Code:**
```
Выполни Этап 4 из plans/006-improvements-v2.md.

Используй скиллы: brandbook-stylist, fastapi-crud

Переделай фильтр целей на странице "Календарь" с одиночного выбора на мультивыбор:

1. Backend:
   - Проверь, поддерживает ли GET /api/calendar/month несколько goal_id
   - Если нет — измени параметр: goal_id: int → goal_ids: list[int] (или поддержи несколько goal_id через запятую)
   - Аналогично для GET /api/calendar/timeline и GET /api/calendar/day/{date}

2. Frontend — GoalFilter.tsx:
   - Замени role="radiogroup" на мультивыбор (checkbox-стиль)
   - Состояние: Set<number> вместо number | null
   - "Все цели" — выбирает/снимает все
   - Клик по цели — toggle включения/выключения
   - Визуально: выбранные цели имеют активный стиль (как сейчас), невыбранные — приглушённый

3. CalendarView.tsx:
   - Замени activeGoalId: number | null на activeGoalIds: Set<number> (или number[])
   - Передавай массив goal_ids в useCalendar
   - URL params: ?goals=1,2,3 вместо ?goal=1

4. useCalendar.ts:
   - Прими массив goalIds вместо одного goalId
   - Формируй запрос с несколькими goal_id

5. Обнови GoalsTimeline и DayDetailsPanel для работы с массивом целей.

Сохрани обратную совместимость: если ни одна цель не выбрана — показывать все.
```

**Результат:**
- [x] Мультивыбор целей в фильтре календаря
- [x] Backend поддерживает массив goal_ids
- [x] Timeline и DayDetails корректно работают с мультивыбором
- [x] URL params обновлены

---

### Этап 5: Сворачиваемая сетка календаря
**Статус:** ✅ Выполнен

**Промпт для Claude Code:**
```
Выполни Этап 5 из plans/006-improvements-v2.md.

Используй скилл: brandbook-stylist

Добавь возможность сворачивать сетку календаря при выборе дня:

1. Поведение:
   - При клике на день в сетке календаря:
     - Сетка календаря плавно сворачивается (collapse с анимацией)
     - Область под сеткой (GoalsTimeline + DayDetailsPanel) занимает весь экран
   - Кнопка "развернуть календарь" для возврата сетки
   - При клике на другой день (пока свёрнуто) — контент обновляется, сетка остаётся свёрнутой

2. UI свёрнутого состояния:
   - Вместо полной сетки — компактная полоска с:
     - Текущий месяц/год
     - Выбранная дата (выделена)
     - Кнопка-стрелка для разворачивания сетки (ChevronDown)
   - Плавная анимация сворачивания/разворачивания (Framer Motion или CSS transition)

3. Развёрнутое состояние (по умолчанию):
   - Полная сетка как сейчас
   - При выборе дня — автоматическое сворачивание

4. Состояние:
   - isGridCollapsed: boolean (по умолчанию false)
   - При выборе дня → isGridCollapsed = true
   - Кнопка разворачивания → isGridCollapsed = false
   - Запоминать состояние в рамках сессии (не localStorage)

5. Адаптивность:
   - На мобильных: сворачивание особенно важно (экономия места)
   - На десктопе: тоже работает

Используй Framer Motion для анимаций (уже в проекте).
```

**Результат:**
- [x] Сетка сворачивается при выборе дня
- [x] Компактная полоска с датой и кнопкой разворачивания
- [x] Плавная анимация
- [x] Контент под сеткой занимает весь экран

---

### Этап 6: Визуализация вех на таймлайне календаря
**Статус:** ✅ Выполнен

**Промпт для Claude Code:**
```
Выполни Этап 6 из plans/006-improvements-v2.md.

Используй скилл: brandbook-stylist

Добавь визуализацию вех на таймлайне календаря (GoalsTimeline):

1. Backend — расширь данные таймлайна:
   - В ответе /api/calendar/timeline для каждой вехи добавь:
     - start_date, end_date (уже есть в модели)
     - progress_percent (расчётный прогресс)
     - is_completed
   - Убедись, что эти поля возвращаются в milestones[] внутри каждой цели

2. Frontend — GoalsTimeline.tsx:
   - Под прогресс-баром каждой цели — показать вехи как вложенные полоски:
     - Каждая веха = мини прогресс-бар внутри диапазона цели
     - Позиция вехи на шкале определяется её start_date/end_date относительно цели
     - Заполнение — progress_percent вехи
     - Цвет вехи — более светлый оттенок цвета цели (или отдельная палитра)

3. Визуальный дизайн:
   - Цель: основной прогресс-бар (как сейчас)
   - Вехи: тонкие полоски под основным баром, каждая позиционирована по своим датам
   - Название вехи — tooltip при наведении или мелкий текст под полоской
   - Завершённые вехи — приглушённый стиль + галочка
   - Текущая веха (сегодня внутри периода) — выделение

4. Интерактивность:
   - Hover на веху — показать tooltip с названием, прогрессом, датами
   - Клик на веху — навигация на страницу вехи (/dashboard/goal/{goalId}/milestone/{milestoneId})

5. Адаптивность:
   - На мобильных: вехи могут скрываться за toggle "Показать вехи"
   - На десктопе: показываются по умолчанию
```

**Результат:**
- [x] Вехи отображаются как вложенные прогресс-бары на таймлайне
- [x] Позиционирование вех соответствует датам
- [x] Прогресс каждой вехи визуализирован
- [x] Tooltip с деталями при наведении
- [x] Клик ведёт на страницу вехи

---

## Зависимости этапов

```
Этап 1 (Прогресс) — независимый, критичный баг
Этап 2 (Навигация) — независимый, простой фикс
Этап 3 (Фильтр Ближайшие) — независимый
Этап 4 (Мультивыбор Календарь) — независимый
    ↓
Этап 5 (Сворачиваемый Календарь) — можно параллельно с 4, но лучше после
    ↓
Этап 6 (Вехи на таймлайне) — зависит от Этапа 4 (мультивыбор влияет на timeline)
```

Этапы 1, 2, 3 — можно выполнять параллельно.
Этап 4 — можно параллельно с 1-3.
Этап 5 — после 4 (мультивыбор меняет CalendarView).
Этап 6 — после 4 (timeline зависит от фильтрации).

---

## Чеклист готовности

### Функциональность
- [ ] Прогресс обновляется мгновенно при toggle действия
- [ ] Логотип ведёт на /dashboard
- [ ] Фильтр по целям на "Ближайшие дни" работает
- [ ] Мультивыбор целей в календаре работает
- [ ] Сетка календаря сворачивается/разворачивается
- [ ] Вехи визуализированы на таймлайне

### UI/UX
- [ ] Анимации плавные (сворачивание, прогресс)
- [ ] Фильтры стилизованы по brandbook
- [ ] Поддержка light/dark темы
- [ ] Адаптивность на мобильных

### Качество
- [ ] Нет console errors
- [ ] Нет TypeScript ошибок
- [ ] URL params работают корректно (bookmarkable)

---

## Используемые скиллы

| Этап | Скиллы |
|------|--------|
| 1 | — |
| 2 | — |
| 3 | brandbook-stylist, fastapi-crud |
| 4 | brandbook-stylist, fastapi-crud |
| 5 | brandbook-stylist |
| 6 | brandbook-stylist |
