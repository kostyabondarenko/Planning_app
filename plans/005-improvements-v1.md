```markdown
# План: Доработки v1 — CRUD, Soft Delete, UI улучшения

## Общее описание

Первый поток доработок по обратной связи. Включает исправление критичных багов CRUD, внедрение soft delete, улучшения UI и навигации.

---

## Входящие требования

### Критичные (баги)
- Не работает кнопка удаления цели
- Не работает кнопка редактирования цели
- Нет возможности редактировать расписание регулярных действий
- Нет возможности редактировать названия (цель, веха, действия)

### Архитектурные
- Soft delete: данные не удалять физически, только скрывать
- Переключатель "показывать завершённые цели" в календаре

### UI/UX улучшения
- Улучшить визуализацию дней недели в регулярных действиях
- Исправить расцветку выбранного дня в селекторе
- Кнопка "Сегодня" на странице Ближайшие дни
- Сортировка однократных действий по дате
- Показывать год в датах
- Улучшить отображение прогресса (текст, округление)
- Автопроставление прогресса + ручная установка 100%
- Favicon

---

## План реализации

### Этап 1: Backend — Soft Delete
**Статус:** ✅ Выполнен

**Промпт для Claude Code:**
```
Выполни Этап 1 из plans/005-improvements-v1.md.

Используй скилл: fastapi-crud

Внедри soft delete для всех основных сущностей:

1. Добавь поля в модели (models.py):
   - Goal: is_archived: bool = False, archived_at: datetime | None
   - Milestone: is_archived: bool = False, archived_at: datetime | None
   - RecurringAction: is_deleted: bool = False
   - OneTimeAction: is_deleted: bool = False

2. Создай миграцию Alembic для новых полей.

3. Обнови существующие эндпоинты:
   - DELETE /api/goals/{id} → устанавливает is_archived=True, archived_at=now()
   - DELETE /api/milestones/{id} → устанавливает is_archived=True
   - DELETE /api/recurring-actions/{id} → устанавливает is_deleted=True
   - DELETE /api/one-time-actions/{id} → устанавливает is_deleted=True

4. Обнови GET-эндпоинты:
   - По умолчанию фильтруй is_archived=False / is_deleted=False
   - Добавь query param ?include_archived=true для показа архивных

5. Добавь эндпоинт восстановления:
   - PUT /api/goals/{id}/restore → is_archived=False, archived_at=None

Не удаляй данные физически ни при каких обстоятельствах.
```

**Результат:**
- [x] Поля is_archived/is_deleted в моделях
- [x] Миграция Alembic
- [x] Soft delete в DELETE-эндпоинтах
- [x] Фильтрация архивных в GET
- [x] Эндпоинт восстановления

---

### Этап 2: Backend — API редактирования
**Статус:** ✅ Выполнен

**Промпт для Claude Code:**
```
Выполни Этап 2 из plans/005-improvements-v1.md.

Используй скилл: fastapi-crud

Добавь/исправь эндпоинты редактирования:

1. PUT /api/goals/{id}
   - Редактирование title, start_date, end_date
   - Валидация: end_date >= start_date
   - Pydantic-схема GoalUpdate

2. PUT /api/milestones/{id}
   - Редактирование title, start_date, end_date, completion_percent
   - Валидация периодов (не пересекаются с другими вехами цели)
   - Pydantic-схема MilestoneUpdate

3. PUT /api/recurring-actions/{id}
   - Редактирование title, weekdays
   - Pydantic-схема RecurringActionUpdate

4. PUT /api/one-time-actions/{id}
   - Редактирование title, deadline, completed
   - Pydantic-схема OneTimeActionUpdate

5. Добавь эндпоинт ручной установки прогресса вехи:
   - PUT /api/milestones/{id}/complete
   - Body: { "force_complete": true }
   - Устанавливает статус завершения независимо от расчётного прогресса

Все эндпоинты требуют JWT и проверку владельца.
```

**Результат:**
- [x] PUT /api/goals/{id}
- [x] PUT /api/milestones/{id}
- [x] PUT /api/recurring-actions/{id}
- [x] PUT /api/one-time-actions/{id}
- [x] PUT /api/milestones/{id}/complete
- [x] Pydantic-схемы Update

---

### Этап 3: Frontend — Исправление CRUD цели
**Статус:** ✅ Выполнен

**Промпт для Claude Code:**
```
Выполни Этап 3 из plans/005-improvements-v1.md.

Используй скилл: react-forms

Исправь функционал удаления и редактирования целей на странице "Цели":

1. Кнопка "Удалить" в просмотре цели:
   - Добавь модальное окно подтверждения
   - При подтверждении: вызов DELETE /api/goals/{id}
   - После успеха: закрыть просмотр, обновить список, показать toast
   - Текст: "Цель перемещена в архив"

2. Кнопка "Редактировать" в просмотре цели:
   - Открывает модальное окно с формой
   - Поля: название, дата начала, дата окончания
   - Предзаполнение текущими значениями
   - При сохранении: PUT /api/goals/{id}
   - Валидация: название не пустое, даты корректны

3. Аналогично для вехи:
   - Кнопка "Редактировать" → модалка с title, датами, completion_percent
   - Кнопка "Удалить" → подтверждение → DELETE

4. Аналогично для действий (регулярных и однократных):
   - Inline-редактирование или модалка
   - Для регулярных: редактирование weekdays
   - Удаление с подтверждением

Используй компоненты проекта: Button, Input, Modal.
Стили по brandbook.
```

**Результат:**
- [x] Работающая кнопка удаления цели
- [x] Модалка подтверждения удаления
- [x] Работающая кнопка редактирования цели
- [x] Форма редактирования цели
- [x] Редактирование/удаление вех
- [x] Редактирование/удаление действий

---

### Этап 4: Frontend — Редактирование расписания регулярных действий
**Статус:** ✅ Выполнен

**Промпт для Claude Code:**
```
Выполни Этап 4 из plans/005-improvements-v1.md.

Используй скиллы: react-forms, brandbook-stylist

Добавь возможность редактировать расписание (weekdays) регулярных действий:

1. В просмотре вехи, для каждого регулярного действия:
   - Кнопка "Изменить расписание" (иконка календаря или карандаша)
   - Клик открывает модалку или inline-редактор

2. Компонент WeekdaySelector (если нет — создай):
   - 7 кнопок-чекбоксов: Пн Вт Ср Чт Пт Сб Вс
   - Выбранные дни подсвечены (accent цвет)
   - Минимум 1 день должен быть выбран

3. Форма редактирования:
   - Показать текущие weekdays
   - При сохранении: PUT /api/recurring-actions/{id}
   - Обновить UI без перезагрузки страницы

4. Стилизация WeekdaySelector:
   - Горизонтальный ряд кнопок
   - Невыбранные: border, bg-tertiary
   - Выбранные: gradient-warm фон, белый текст
   - Hover-эффект на невыбранных

Учти, что этот компонент также используется при создании действия.
```

**Результат:**
- [x] Компонент WeekdaySelector (переиспользуемый)
- [x] Кнопка редактирования расписания
- [x] Модалка/форма редактирования
- [x] Интеграция с API
- [x] Стили по brandbook

---

### Этап 5: Frontend — Улучшение UI выбора дней недели
**Статус:** ✅ Выполнен

**Промпт для Claude Code:**
```
Выполни Этап 5 из plans/005-improvements-v1.md.

Используй скилл: brandbook-stylist

Улучши визуализацию дней недели в регулярных действиях (при просмотре вехи):

1. Создай HTML-файл с 3 вариантами дизайна (docs/weekday-variants.html):

   Вариант A — Календарная сетка:
   - 7 ячеек в ряд, фиксированная ширина
   - Запланированные дни: заливка accent цветом
   - Незапланированные: border, прозрачный фон
   - Все дни всегда видны

   Вариант B — Pills/теги:
   - Горизонтальный ряд pill-кнопок
   - Запланированные: gradient-warm фон
   - Незапланированные: приглушённые, мелкий текст

   Вариант C — Круговой/компактный:
   - Круглые иконки 32x32
   - Запланированные: заливка + галочка
   - Незапланированные: только border

2. Также покажи варианты для состояния "выбранный день" в селекторе:
   - Текущий баг: выбранный день сливается с фоном
   - Покажи 2-3 варианта подсветки выбора

3. Добавь поддержку light/dark темы для каждого варианта.

4. HTML должен быть интерактивным:
   - Переключатель темы
   - Возможность "выбрать" дни клик ом для демонстрации

После выбора варианта — реализуй выбранный в компоненте.
```

**Результат:**
- [x] HTML-файл docs/weekday-variants.html
- [x] 3 варианта визуализации дней
- [x] Варианты подсветки выбора
- [x] Поддержка light/dark
- [x] Интерактивная демонстрация

---

### Этап 6: Frontend — Навигация и сортировка
**Статус:** ✅ Выполнен

**Промпт для Claude Code:**
```
Выполни Этап 6 из plans/005-improvements-v1.md.

Добавь улучшения навигации и сортировки:

1. Кнопка "Сегодня" на странице Ближайшие дни:
   - Расположение: рядом с селектором количества дней
   - При клике: прокрутить доску к колонке "Сегодня"
   - Если сегодня уже видно — подсветить колонку кратковременно
   - Стиль: btn-secondary, иконка Calendar или Home

2. Авто-сортировка однократных действий по дате:
   - При отображении в просмотре вехи: сортировать по deadline ASC
   - Ближайшие дедлайны сверху
   - Просроченные — выделить цветом (accent-error)

3. Показывать год в датах:
   - Формат дат: "15 янв 2026" вместо "15 янв"
   - Применить везде: цели, вехи, действия, календарь
   - Для текущего года можно опционально скрывать (настройка)

Используй существующие компоненты и стили.
```

**Результат:**
- [x] Кнопка "Сегодня" на Kanban-доске
- [x] Прокрутка к сегодняшнему дню с подсветкой
- [x] Сортировка однократных действий по дате (deadline ASC, просроченные выделены)
- [x] Год в датах везде (единая утилита formatDate.ts)

---

### Этап 7: Frontend — Прогресс и завершение вех
**Статус:** ✅ Выполнен

**Промпт для Claude Code:**
```
Выполни Этап 7 из plans/005-improvements-v1.md.

Используй скиллы: react-forms, brandbook-stylist

Улучши логику и отображение прогресса:

1. Автопроставление прогресса для завершённых вех:
   - Если end_date вехи в прошлом И условие выполнено → статус "Завершена"
   - Если end_date в прошлом И условие НЕ выполнено → показать окно выбора
   - Проверять при загрузке страницы целей

2. Ручная установка 100% для вехи:
   - В окне-подсказке (когда веха просрочена) добавить опцию "Отметить как выполненную"
   - Кнопка "Завершить веху" в просмотре вехи
   - Вызов PUT /api/milestones/{id}/complete

3. Улучшить текст прогресса:
   - Было: "65% выполнено" и дубль "65%"
   - Стало: при 100% показывать "Готово ✓" или просто "100%"
   - Убрать дублирование текста

4. Округление процента:
   - Для длинных вех (>30 дней): округлять до десятков (40%, 50%)
   - Для коротких: можно точнее (45%, 67%)
   - Не показывать десятичные (45.5% → 46%)

5. Визуализация в просмотре вехи:
   - Завершённая веха: зелёная галочка, приглушённый стиль
   - Просроченная незавершённая: красная подсветка, призыв к действию
```

**Результат:**
- [x] Автопроверка статуса вех при загрузке
- [x] Кнопка "Завершить веху"
- [x] Улучшенный текст прогресса
- [x] Округление процентов
- [x] Визуальные состояния вех

---

### Этап 8: Frontend — Календарь: переключатель завершённых
**Статус:** ✅ Выполнен

**Промпт для Claude Code:**
```
Выполни Этап 8 из plans/005-improvements-v1.md.

Используй скилл: brandbook-stylist

Добавь переключатель "показывать завершённые цели" на странице Календарь:

1. UI переключателя:
   - Расположение: в секции фильтров, после pill-кнопок целей
   - Стиль: toggle switch или checkbox с лейблом
   - Текст: "Показать архивные"
   - По умолчанию: выключен

2. Логика:
   - Выключен: GET /api/calendar/month без архивных
   - Включен: GET /api/calendar/month?include_archived=true
   - Сохранять состояние в localStorage

3. Отображение архивных целей:
   - В фильтре: добавить pill-кнопки для архивных целей
   - Архивные цели: приглушённый стиль, иконка архива
   - В календаре: точки архивных целей с пониженной opacity
   - В timeline: архивные цели внизу, приглушённый стиль

4. Возможность восстановить цель:
   - При клике на архивную цель в фильтре → показать tooltip "Восстановить?"
   - Или добавить кнопку в детализации дня

Стилизация по brandbook, поддержка light/dark темы.
```

**Результат:**
- [x] Toggle "Показать архивные"
- [x] Интеграция с API (include_archived)
- [x] Стилизация архивных целей
- [x] Сохранение в localStorage
- [x] Возможность восстановления

---

### Этап 9: Favicon и мелкие улучшения
**Статус:** ✅ Выполнен

**Промпт для Claude Code:**
```
Выполни Этап 9 из plans/005-improvements-v1.md.

Мелкие улучшения:

1. Favicon:
   - Создай favicon на основе логотипа (мишень из brandbook)
   - Форматы: favicon.ico (16x16, 32x32), apple-touch-icon.png (180x180)
   - Цвета: gradient-warm для светлой темы
   - Разместить в frontend/public/

2. Обнови next.config или layout.tsx:
   - Подключи favicon
   - Добавь meta-теги для PWA (theme-color)

3. Проверь title страниц:
   - Главная: "Goal Navigator"
   - Цели: "Цели — Goal Navigator"
   - Календарь: "Календарь — Goal Navigator"
   - Ближайшие дни: "Ближайшие дни — Goal Navigator"

4. Добавь manifest.json для PWA (если нет):
   - name, short_name, icons, theme_color, background_color
```

**Результат:**
- [x] favicon.ico в public/
- [x] apple-touch-icon.png
- [x] Подключение в layout
- [x] Корректные title страниц
- [x] manifest.json обновлён

---

## Зависимости этапов

```
Этап 1 (Soft Delete Backend)
    ↓
Этап 2 (API редактирования)
    ↓
Этап 3 (CRUD Frontend) ←── Этап 4 (Расписание)
    ↓
Этап 5 (UI дней недели) — независимый, можно параллельно
    ↓
Этап 6 (Навигация) — независимый
    ↓
Этап 7 (Прогресс) — зависит от Этапа 2
    ↓
Этап 8 (Календарь архивные) — зависит от Этапа 1
    ↓
Этап 9 (Favicon) — независимый, можно в любой момент
```

---

## Чеклист готовности

### Функциональность
- [ ] Soft delete работает для всех сущностей
- [ ] Удаление цели работает (кнопка + подтверждение)
- [ ] Редактирование цели работает
- [ ] Редактирование вехи работает
- [ ] Редактирование действий работает
- [ ] Редактирование расписания регулярных действий
- [ ] Кнопка "Сегодня" на Kanban
- [ ] Сортировка однократных по дате
- [ ] Год отображается в датах
- [ ] Прогресс отображается корректно
- [ ] Ручное завершение вехи работает
- [ ] Переключатель архивных в календаре

### UI/UX
- [ ] Новая визуализация дней недели
- [ ] Корректная расцветка выбранного дня
- [ ] Favicon отображается
- [ ] Title страниц корректны
- [ ] Стили соответствуют brandbook
- [ ] Поддержка light/dark темы

### Качество
- [ ] Backend тесты для новых эндпоинтов
- [ ] Нет console errors
- [ ] Нет TypeScript ошибок

---

## Используемые скиллы

| Этап | Скиллы |
|------|--------|
| 1 | fastapi-crud |
| 2 | fastapi-crud |
| 3 | react-forms |
| 4 | react-forms, brandbook-stylist |
| 5 | brandbook-stylist |
| 6 | — |
| 7 | react-forms, brandbook-stylist |
| 8 | brandbook-stylist |
| 9 | — |
```